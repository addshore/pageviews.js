/**
 * @license
 * Copyright 2017 Thomas Steiner (@tomayac). All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var request,USER_AGENT="pageviews.js",environment="undefined"==typeof window?"node":"browser";if("node"===environment){request=require("request");var packageJson=require("./package.json");USER_AGENT="pageviews.js-v"+packageJson.version+" ("+packageJson.repository.url+")"}else request=function(e,r){var t=new XMLHttpRequest;t.addEventListener("load",function(){return r(null,{statusCode:this.status},this.responseText)}),t.addEventListener("error",function(e){return r(e)}),t.open("GET",e.url),t.send()};var pageviews=function(){function d(e,r){function t(e){return e<10?"0"+e:e.toString()}if(!e)return new Error("Required parameters missing.");if(!e.project&&!e.projects)return"getAggregatedPageviews"===r||"getTopPageviews"===r||"getTopPageviewsByCountry"===r||"getAggregatedLegacyPagecounts"===r?new Error('Required parameter "project" or "projects" missing.'):new Error('Required parameter "project" missing.');if(e.project&&"all-projects"!==e.project&&"wikidata"!==e.project&&-1===e.project.indexOf("."))return new Error('Required parameter "project" invalid.');if(("getAggregatedPageviews"===r||"getAggregatedLegacyPagecounts"===r||"getTopPageviews"===r||"getTopPageviewsByCountry"===r)&&e.projects&&"all-projects"!==e.projects&&(!Array.isArray(e.projects)||!e.projects.length||e.projects.filter(function(e){return-1===e.indexOf(".")&&"all-projects"!==e&&"wikidata"!==e}).length))return new Error('Required parameter "projects" invalid.');if("getPerArticlePageviews"===r){if(!e.article&&!e.articles)return new Error('Required parameter "article" or "articles" missing.');if(e.articles&&(!Array.isArray(e.articles)||!e.articles.length))return new Error('Required parameter "articles" invalid.')}if("getPerArticlePageviews"===r||"getUniqueDevices"===r){if(!e.start)return new Error('Required parameter "start" missing.');if(e.start="object"==typeof e.start?e.start.getUTCFullYear()+t(e.start.getUTCMonth()+1)+t(e.start.getUTCDate()):e.start,!/^(?:19|20)\d\d[- /.]?(?:0[1-9]|1[012])[- /.]?(?:0[1-9]|[12][0-9]|3[01])$/.test(e.start))return new Error('Required parameter "start" invalid.');if(!e.end)return new Error('Required parameter "end" missing.');if(e.end="object"==typeof e.end?e.end.getUTCFullYear()+t(e.end.getUTCMonth()+1)+t(e.end.getUTCDate()):e.end,!/^(19|20)\d\d[- /.]?(0[1-9]|1[012])[- /.]?(0[1-9]|[12][0-9]|3[01])$/.test(e.end))return new Error('Required parameter "end" invalid.')}else if("getAggregatedPageviews"===r||"getAggregatedLegacyPagecounts"===r){if(!e.start)return new Error('Required parameter "start" missing.');if(e.start="object"==typeof e.start?e.start.getUTCFullYear()+t(e.start.getUTCMonth()+1)+(t(e.start.getUTCDate())+t(e.start.getUTCHours())):e.start,!/^(?:19|20)\d\d[- /.]?(?:0[1-9]|1[012])[- /.]?(?:0[1-9]|[12][0-9]|3[01])[- /.]?(?:[012][0-9])$/.test(e.start))return new Error('Required parameter "start" missing or invalid.');if(!e.end)return new Error('Required parameter "end" missing.');if(e.end="object"==typeof e.end?e.end.getUTCFullYear()+t(e.end.getUTCMonth()+1)+t(e.end.getUTCDate())+t(e.end.getUTCHours()):e.end,!/^(19|20)\d\d[- /.]?(0[1-9]|1[012])[- /.]?(0[1-9]|[12][0-9]|3[01])[- /.]?(?:[012][0-9])$/.test(e.end))return new Error('Required parameter "end" missing or invalid.')}if("getTopPageviewsByCountry"===r){if(!e.year||!/^(?:19|20)\d\d$/.test(e.year))return new Error('Required parameter "year" missing or invalid.');if(!e.month||!/^(?:0?[1-9]|1[012])$/.test(e.month))return new Error('Required parameter "month" missing or invalid.');if(e.access&&-1===f.allowed.indexOf(e.access))return new Error('Invalid optional parameter "access".')}if("getTopPageviews"===r){if(e.date&&(e.date="object"==typeof e.date?e.date:new Date(e.date.substr(0,4)+"-"+e.date.substr(4,2)+"-"+e.date.substr(6,2)),e.year=e.date.getUTCFullYear(),e.month=t(e.date.getUTCMonth()+1),e.day=t(e.date.getUTCDate())),!e.year||!/^(?:19|20)\d\d$/.test(e.year))return new Error('Required parameter "year" missing or invalid.');if(!e.month||!/^(?:0?[1-9]|1[012])$/.test(e.month))return new Error('Required parameter "month" missing or invalid.');if(!e.day||!/^(?:0?[1-9]|[12][0-9]|3[01])$/.test(e.day))return new Error('Required parameter "day" missing or invalid.');if(e.limit&&!/^\d+$/.test(e.limit)&&0<e.limit&&e.limit<=1e3)return new Error('Invalid optional parameter "limit".')}if(e.access&&-1===f.allowed.indexOf(e.access))return new Error('Invalid optional parameter "access".');if(e.accessSite&&-1===c.allowed.indexOf(e.accessSite))return new Error('Invalid optional parameter "accessSite".');if(e.agent&&-1===m.allowed.indexOf(e.agent))return new Error('Invalid optional parameter "agent".');if(e.granularity)if("getAggregatedPageviews"===r||"getAggregatedLegacyPagecounts"===r){if(-1===l.allowed.indexOf(e.granularity))return new Error('Invalid optional parameter "granularity".')}else if("getPerArticlePageviews"===r){if(-1===v.allowed.indexOf(e.granularity))return new Error('Invalid optional parameter "granularity".')}else if("getUniqueDevices"===r&&-1===u.allowed.indexOf(e.granularity))return new Error('Invalid optional parameter "granularity".');return e}function g(e,r,t){var a;if(e||200!==r.statusCode){if(e)return e;if(404===r.statusCode)try{return a=JSON.parse(t),new Error(a.detail||a.title)}catch(e){return new Error(e)}return new Error("Status code "+r.statusCode)}try{a=JSON.parse(t)}catch(e){return new Error(e)}return a}var p="https://wikimedia.org/api/rest_v1",f={default:"all-access",allowed:["all-access","desktop","mobile-web","mobile-app"]},c={default:"all-sites",allowed:["all-sites","desktop-site","mobile-site","all-access"]},m={default:"all-agents",allowed:["all-agents","user","spider","bot"]},l={default:"hourly",allowed:["daily","hourly","monthly"]},v={default:"daily",allowed:["daily","monthly"]},u={default:"daily",allowed:["daily","monthly"]},w=function(l){return new Promise(function(n,i){if((l=d(l,"getPerArticlePageviews")).stack)return i(l);if(l.articles){var a=[];return l.articles.map(function(e,r){var t=l;delete t.articles,t.article=e,a[r]=w(t)}),n(Promise.all(a))}var e=l.project,r=encodeURIComponent(l.article.replace(/\s/g,"_")),t=l.start,s=l.end,o=l.access?l.access:f.default,u=l.agent?l.agent:m.default,c=l.granularity?l.granularity:v.default;request({url:p+"/metrics/pageviews/per-article/"+e+"/"+o+"/"+u+"/"+r+"/"+c+"/"+t+"/"+s,headers:{"User-Agent":USER_AGENT}},function(e,r,t){var a=g(e,r,t);return(a.stack?i:n)(a)})})},y=function(c){return new Promise(function(n,i){if((c=d(c,"getAggregatedPageviews")).stack)return i(c);if("all-projects"===c.projects&&(c.projects=null,c.project="all-projects"),c.projects){var a=[];return c.projects.map(function(e,r){var t=c;delete t.projects,t.project=e,a[r]=y(t)}),n(Promise.all(a))}var e=c.project,r=c.start,t=c.end,s=c.access?c.access:f.default,o=c.agent?c.agent:m.default,u=c.granularity?c.granularity:l.default;request({url:p+"/metrics/pageviews/aggregate/"+e+"/"+s+"/"+o+"/"+u+"/"+r+"/"+t,headers:{"User-Agent":USER_AGENT}},function(e,r,t){var a=g(e,r,t);return(a.stack?i:n)(a)})})},j=function(u){return new Promise(function(n,i){if((u=d(u,"getAggregatedLegacyPagecounts")).stack)return i(u);if("all-projects"===u.projects&&(u.projects=null,u.project="all-projects"),u.projects){var a=[];return u.projects.map(function(e,r){var t=u;delete t.projects,t.project=e,a[r]=j(t)}),n(Promise.all(a))}var e=u.project,r=u.start,t=u.end,s=u.accessSite?u.accessSite:c.default,o=u.granularity?u.granularity:l.default;request({url:p+"/metrics/legacy/pagecounts/aggregate/"+e+"/"+s+"/"+o+"/"+r+"/"+t,headers:{"User-Agent":USER_AGENT}},function(e,r,t){var a=g(e,r,t);return(a.stack?i:n)(a)})})},E=function(c){return new Promise(function(n,i){if((c=d(c,"getTopPageviews")).stack)return i(c);if(c.projects){var a=[];return c.projects.map(function(e,r){var t=c;delete t.projects,t.project=e,a[r]=E(t)}),n(Promise.all(a))}var e=c.project,r=c.year,t="number"==typeof c.month&&c.month<10?"0"+c.month:c.month,s="number"==typeof c.day&&c.day<10?"0"+c.day:c.day,o=c.limit||!1,u=c.access?c.access:f.default;request({url:p+"/metrics/pageviews/top/"+e+"/"+u+"/"+r+"/"+t+"/"+s,headers:{"User-Agent":USER_AGENT}},function(e,r,t){var a=g(e,r,t);return a.stack?i(a):(o&&(a.items[0].articles=a.items[0].articles.slice(0,o)),n(a))})})},P=function(o){return new Promise(function(n,i){if((o=d(o,"getTopPageviewsByCountry")).stack)return i(o);if(o.projects){var a=[];return o.projects.map(function(e,r){var t=o;delete t.projects,t.project=e,a[r]=P(t)}),n(Promise.all(a))}var e=o.project,r=o.year,t="number"==typeof o.month&&o.month<10?"0"+o.month:o.month,s=o.access?o.access:f.default;request({url:p+"/metrics/pageviews/top-by-country/"+e+"/"+s+"/"+r+"/"+t,headers:{"User-Agent":USER_AGENT}},function(e,r,t){var a=g(e,r,t);return(a.stack?i:n)(a)})})};return{getPageviewsDimensions:function(){return new Promise(function(n,i){request({url:p+"/metrics/pageviews/",headers:{"User-Agent":USER_AGENT}},function(e,r,t){var a=g(e,r,t);return(a.stack?i:n)(a)})})},getPerArticlePageviews:w,getAggregatedPageviews:y,getAggregatedLegacyPagecounts:j,getTopPageviews:E,getTopPageviewsByCountry:P,getUniqueDevices:function(o){return new Promise(function(n,i){if((o=d(o,"getUniqueDevices")).stack)return i(o);var e=o.project,r=o.start,t=o.end,a=o.accessSite?o.accessSite:c.default,s=o.granularity?o.granularity:u.default;request({url:p+"/metrics/unique-devices/"+e+"/"+a+"/"+s+"/"+r+"/"+t,headers:{"User-Agent":USER_AGENT}},function(e,r,t){var a=g(e,r,t);return(a.stack?i:n)(a)})})}}}();"node"===environment&&(module.exports=pageviews);